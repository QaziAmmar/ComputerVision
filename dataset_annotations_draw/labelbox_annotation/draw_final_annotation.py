# //  Created by Qazi Ammar Arshad on 30/06/2020.
# //  Copyright Â© 2020 Qazi Ammar Arshad. All rights reserved.
"""
This code draw the annotation file on the images that are generated by merging the label box and code annotation files
togather.
"""
from custom_classes import path
import json
import cv2
import os

# folder base path.
folder_base_path = path.dataset_path + "IML_dataset/new_microcsope/p.v/"
final_annotation_path = folder_base_path + "CodePlusLabelBox_annotation.json"
# read json file
with open(final_annotation_path) as annotation_path:
    final_annotaion = json.load(annotation_path)

json_dictionary = []

# %%

for image_annotation in final_annotaion:
    # we are testing on subset of images so first we check if images
    img_name = image_annotation["image_name"]
    img_path = folder_base_path + "100X_crop/" + img_name
    if not os.path.isfile(img_path):
        print("No file Found")
        continue
    print(img_name)
    # load image for testing either annotation are combining in correct way
    img = cv2.imread(folder_base_path + "100X_crop/" + image_annotation["image_name"])
    image = img.copy()
    json_object = []
    counter = 1
    for point in image_annotation["objects"]:
        x = int(point['x'])
        y = int(point['y'])
        h = int(point['h'])
        w = int(point['w'])
        cv2.rectangle(img, (x, y), (x + w, y + h), (0, 0, 255), 2)
        roi = image[y:y + h, x:x + w]
        cell_name = img_name[:-4] + "_" + str(counter) + ".JPG"
        json_object.append({
            "cell_name": cell_name,
            "x": str(x),
            "y": str(y),
            "h": str(h),
            "w": str(w),
        })

        cv2.imwrite(folder_base_path + "rbc/" + cell_name, roi)
        counter += 1

    #     save image annotated image
    cv2.imwrite(folder_base_path + "final_image_code/" + img_name, img)
    #   save cell location in json file.
    json_dictionary.append({
        "image_name": img_name,
        "objects": json_object
    })

# save cell json file.
save_json_image_path = folder_base_path + "rbc_location/" + "single_cell_location.json"
with open(save_json_image_path, "w") as outfile:
    json.dump(json_dictionary, outfile)
